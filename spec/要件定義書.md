# Minecraft単発サーバー管理BOT 要件定義書

## 1. プロジェクト概要

### 1.1 背景
現在、Minecraftの単発サーバー管理において以下の作業を手動で行っており、運営負荷が高い状態。
- 申請の受理
- パネルのユーザー追加
- サーバーの権限付与
- 利用者への連絡
- 貸与期間終了後のバックアップ、初期化、権限剥奪

### 1.2 目的
Discord BOTを活用してサーバー貸与プロセスを半自動化し、運営負荷を軽減する。

### 1.3 前提条件
- サーバーはPterodactylサーバーパネルで管理されている
- PterodactylのAPIを活用して各種操作の自動化が可能

### 1.4 登場人物の定義
本システムでは以下3種類のユーザーが関与する：
1. **申請者**: 申請したDiscordユーザー（サーバー貸出を申請する人）
2. **主催者**: リマインド通知を受け取る責任者、バックアップ時のフォルダ名にも記載される
3. **パネル権限付与対象ユーザー**: Pterodactylパネルでサーバーの権限を付与されるユーザー（複数人の場合あり）

## 2. 機能要件

### 2.1 貸出申請機能
**機能名**: サーバー貸出申請フォーム  
**概要**: Discordのフォーム機能を使用してサーバー貸出申請を受け付ける

**入力項目**:
- サーバーの説明/用途
- 希望Minecraftバージョン
- 貸出希望期間
- 主催者の指定
- パネル権限付与対象ユーザーの指定（複数可）

**処理内容**:
- 申請情報をデータベースに記録（申請者のDiscordユーザー情報含む）
- 申請受付の自動通知
- 管理者による承認待ち状態へ移行

### 2.2 管理者承認機能
**機能名**: 申請承認とユーザー作成  
**概要**: 管理者が申請を承認し、Pterodactylユーザーを作成する

**処理内容**:
- 申請一覧の表示
- 管理者による承認判定
- もしDBに登録されていなければ
  - ユーザー名の決定（管理者が設定）
  - メールアドレス生成（`[username]@kpw.local`形式）
  - パネル権限付与対象ユーザーのDiscordユーザーとPterodactylユーザーの関連付けをDBに保存
- パネル権限付与対象ユーザーに専用のDiscordロールを付与（未付与の場合のみ）

### 2.3 自動サーバー割り当て機能
**機能名**: サーバー自動割り当て  
**概要**: 承認後、利用可能なサーバーを自動で割り当てる

**処理内容**:
- 利用可能なサーバーの検索
- パネル権限付与対象ユーザーをPterodactylパネルに追加
- パネル権限付与対象ユーザーにサーバー権限を付与
- 貸出開始日の記録
- パネル権限付与対象ユーザーへの接続情報通知
- 主催者にはどのサーバーが割り当てられたかを通知

### 2.4 貸出情報管理機能
**機能名**: 貸出状況管理  
**概要**: 現在の貸出状況を管理・表示する

**管理項目**:
- pterodactylのサーバーID
- 申請者のDiscordユーザー情報
- 主催者のDiscordユーザー情報
- パネル権限付与対象ユーザーの情報（複数）
- Pterodactylユーザー名（パネル権限付与対象ユーザー分）
- メールアドレス（`[username]@kpw.local`、パネル権限付与対象ユーザー分）
- 貸出開始日
- 貸出期間
- 利用状況

### 2.5 期限管理・リマインド機能
**機能名**: 期限管理とリマインド通知  
**概要**: 貸出期限の管理とユーザーへの事前通知を行う

**処理内容**:
- 期限切れ予定サーバーの検出（例：3日前、1日前）
- 主催者への期限切れリマインド通知
- 期限延長申請の受付（必要に応じて）

### 2.6 管理者向けサーバー管理機能
**機能名**: 手動サーバー管理  
**概要**: 管理者による柔軟なサーバー管理を可能にする

**処理内容**:
- 貸出期限の変更
- 即時強制返却の実行（バックアップ選択フロー含む）
- サーバー状態の手動確認

### 2.7 自動返却フロー機能
**機能名**: 自動返却フロー  
**概要**: 期限切れサーバーを検出して自動的に返却処理を実行する

**処理内容**:
- 期限切れサーバーの検出
- 返却処理機能の呼び出し

### 2.8 返却処理機能
**機能名**: サーバー返却処理  
**概要**: 自動返却及び手動返却（コマンドによる）実行時に呼ばれる共通の返却処理

**処理内容**:
- Pterodactylから利用可能なバックアップ一覧を取得
- 管理者に対するバックアップ選択画面の表示
- 選択されたバックアップのGoogle Driveへの保存
- ロックされているバックアップのロック解除
- サーバーの初期化
- パネル権限付与対象ユーザーの権限剥奪（configで除外指定されたユーザーを除く）
- 主催者・パネル権限付与対象ユーザーへの返却通知

**バックアップ選択フロー**:
1. Pterodactylから最新バックアップとロックされたバックアップをサジェスト
2. 管理者がサジェストされたバックアップから選択
3. 必要に応じて補足コメントを追加
4. 保存先フォルダを自動作成してバックアップを保存
5. バックアップ保存完了後、そのサーバーのロックされている全バックアップのロックを解除

**バックアップファイル命名規則**:
`企画鯖ワールドデータ\YYYY\[ID]_YYYYMMdd_企画名_[Name]主催\[バックアップの日付]_[補足(あれば)].tar.gz`
- YYYY: 年
- ID: 申請ID（DB上のprimary_keyを使用）
- YYYYMMdd: フォームで管理者が入力
- 企画名: サーバーの説明/用途から取得
- Name: 主催者名
- バックアップの日付: 選択されたバックアップの作成日時
- 補足: 管理者が入力した任意のコメント

## 3. 技術要件

### 3.1 使用技術
- Discord.js (Discord BOT開発)
- TypeScript
- Pterodactyl API
- データベース (MySQL/prisma)

### 3.2 外部API
- Discord API
- Pterodactyl Panel API
- GoogleDrive（RClone）

### 3.3 データ管理
- 申請情報の永続化
- 申請者・主催者・パネル権限付与対象ユーザーの関連付け管理
- 貸出履歴の管理
- バックアップファイルのメタデータ管理（Google Drive上のファイルパス等）
- 権限変更除外ユーザーの設定管理

## 4. 非機能要件

### 4.1 運用性
- 管理者向けの操作コマンド
- リマインド通知のスケジューリング機能
- 権限変更除外ユーザーの設定機能
- ログ出力とエラー通知
- 設定変更の容易性

## 5. 制約事項

### 5.1 技術的制約
- Pterodactyl APIの制限に準拠
- Discordの利用制限に準拠

### 5.2 運用制約
- サーバーリソースの上限
- 同時貸出可能数の制限
